<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>出退勤管理システム</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body { font-family:"Noto Sans JP", sans-serif; background: linear-gradient(135deg, #1e90ff, #00bfff); display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; color:#333; }
section { background:#fff; padding:30px; border-radius:20px; box-shadow:0 6px 25px rgba(0,0,0,0.25); text-align:center; width:90%; max-width:400px; display:none; }
h2 { color:#0078ff; margin-bottom:15px; font-size:1.5rem; }
input[type="password"] { padding:12px; width:85%; font-size:16px; border-radius:10px; border:1px solid #ccc; margin-bottom:15px; }
button { background:#0078ff; color:white; border:none; padding:12px 25px; border-radius:10px; font-size:16px; cursor:pointer; transition:0.3s; }
button:hover { background:#005fcc; }
#reader { width:100%; max-width:300px; margin:15px auto; position:relative; border:3px solid #0078ff; border-radius:15px; overflow:hidden; }
#status { margin-top:12px; font-weight:bold; transition: color 0.3s; min-height:24px; }
#clock { font-size:18px; font-weight:bold; color:#0078ff; margin-bottom:10px; }
</style>
</head>
<body>

<!-- LOGIN -->
<section id="login-container">
  <h2>🔒 ログイン</h2>
  <p>パスワードを入力してください</p>
  <input type="password" id="password" placeholder="パスワード">
  <br>
  <button id="login-btn">ログイン</button>
  <p id="login-error" style="color:red; display:none;">❌ パスワードが間違っています</p>
</section>

<!-- SCANNER -->
<section id="scanner-container">
  <div id="clock">--:--:--</div>
  <h2>📷 出退勤スキャン</h2>
  <div id="reader"></div>
  <p id="status">読み取り待機中...</p>
</section>

<script>
const PASSWORD = "1234";
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycby9cP46KLV2eSTLoLs5Hb-aJtl6knEbgDbxwP8lXFk5XBbFxHPChEUMFyyoilhUnrftyw/exec"; // <== PON TU URL DE APPS SCRIPT
let qrReader, escaneando = true;

// AUDIO
let audioContext;
function inicializarAudio() {
  if(!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)();
}

function reproducirSonidoScan(){
  if(!audioContext) return;
  audioContext.resume();
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.connect(gain); gain.connect(audioContext.destination);
  osc.frequency.setValueAtTime(880, audioContext.currentTime);
  osc.type='square';
  gain.gain.setValueAtTime(0.2, audioContext.currentTime);
  osc.start(audioContext.currentTime);
  osc.stop(audioContext.currentTime +0.1);
}

function reproducirSonidoExito(){
  if(!audioContext) return;
  audioContext.resume();
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.connect(gain); gain.connect(audioContext.destination);
  osc.frequency.setValueAtTime(523.25, audioContext.currentTime);
  osc.type='sine';
  gain.gain.setValueAtTime(0.5, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime +0.5);
  osc.start(audioContext.currentTime);
  osc.stop(audioContext.currentTime +0.5);
}

// LOGIN
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("login-container").style.display="block";
  document.getElementById("login-btn").addEventListener("click", login);
  document.getElementById("password").addEventListener("keypress",(e)=>{if(e.key==="Enter") login();});
});

function login(){
  inicializarAudio();
  const input = document.getElementById("password").value.trim();
  if(input===PASSWORD){
    document.getElementById("login-container").style.display="none";
    document.getElementById("scanner-container").style.display="block";
    iniciarReloj();
    iniciarQR();
  } else{
    const error=document.getElementById("login-error");
    error.style.display="block";
    setTimeout(()=>error.style.display="none",3000);
  }
}

// RELOJ
function iniciarReloj(){
  const opciones={timeZone:'Asia/Tokyo',hour:'2-digit',minute:'2-digit',second:'2-digit',year:'numeric',month:'2-digit',day:'2-digit'};
  const reloj=document.getElementById("clock");
  setInterval(()=>{reloj.textContent=new Date().toLocaleString("ja-JP",opciones);},1000);
}

// QR
function iniciarQR(){
  qrReader = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras=>{
    if(cameras && cameras.length){
      let camara=cameras.find(c=>c.label.toLowerCase().includes("front")||c.label.toLowerCase().includes("user"))||cameras[0];
      qrReader.start(camara.id,{fps:10,qrbox:250},procesarQR,()=>{});
    }
  });
}

// PROCESAR QR
function procesarQR(decodedText){
  if(!escaneando) return;
  escaneando=false;
  reproducirSonidoScan();

  try{
    const datos=JSON.parse(decodedText);
    if(!datos.id || !datos.nombre) throw new Error("ID o nombre faltante");
    const params=new URLSearchParams();
    params.append('id',datos.id);
    params.append('nombre',datos.nombre);
    const url=URL_SCRIPT+'?'+params.toString();

    fetch(url).then(r=>r.json()).then(resultado=>{
      if(resultado.status==="success"){
        reproducirSonidoExito();
        document.getElementById("status").textContent="✅ 登録OK";
      } else{
        document.getElementById("status").textContent="❌ エラー";
      }
      setTimeout(()=>{escaneando=true; document.getElementById("status").textContent="読み取り待機中...";},2000);
    }).catch(e=>{
      document.getElementById("status").textContent="❌ 送信エラー";
      setTimeout(()=>{escaneando=true; document.getElementById("status").textContent="読み取り待機中...";},3000);
    });
  } catch(e){
    document.getElementById("status").textContent="❌ 無効なQRコード";
    setTimeout(()=>{escaneando=true; document.getElementById("status").textContent="読み取り待機中...";},2000);
  }
}
</script>
</body>
</html>
